
<style>
    .inputRow{
        margin-bottom: 10px;
    }
    .inputRow input[type=text], .inputRow textarea{
        border: 1px solid black;
        width: 100%
    }
    #requestError{
        color: red;
        margin-top:20px;
        display:none;
    }
    #requestSuccess{
        color: green;
        margin-top:20px;
        display:none;
    }
</style>
<script src="https://sdk.amazonaws.com/js/aws-sdk-2.283.1.min.js"></script>
<div class="container">
	<div class="row">
		<div class="col-12">
            <form id="channel-form">
                <div class="row inputRow">
            	    <div class="col-5">
                        Do you want to edit Channel?
                    </div>
                    <div class="col-7">
                        <input type="radio" name="is_edit" value="1"><label for="male">Yes</label>&nbsp;&nbsp;
                        <input type="radio" name="is_edit" value="0" checked><label for="female">No</label>
                    </div>
            	</div>
			    <div class="row inputRow">
                    <div class="col-3">Permalink</div>
                    <div class="col-1">:</div>
                    <div class="col-8"><input type="text" name="permalink" /></div>
                </div>
                <div class="row inputRow">
			        <div class="col-3">Name</div>
			        <div class="col-1">:</div>
			        <div class="col-8"><input type="text" name="name" /></div>
                </div>
                <div class="row inputRow">
			        <div class="col-3">Description</div>
                    <div class="col-1">:</div>
                    <div class="col-8"><textarea name="description" rows="2" cols="50" ></textarea></div>
                </div>
                <div class="row inputRow">
                    <div class="col-3">Tagline</div>
                    <div class="col-1">:</div>
                    <div class="col-8"><textarea name="tagline" rows="2" cols="50" ></textarea></div>
                </div>
                <div class="row inputRow">
                    <div class="col-3">New all tags</div>
                    <div class="col-1">:</div>
                    <div class="col-8"><input type="text" name="tags" placeholder="Comma saperated New tags" /></div>
                </div>
                <div class="row inputRow">
                    <div class="col-3">Admins</div>
                    <div class="col-1">:</div>
                    <div class="col-8"><input type="text" name="admins" placeholder="Comma saperated user names" /></div>
			    </div>

			    <input id="original_image_url" type="hidden" name="original_image_url">
			    <input id="original_image_file_size" type="hidden" name="original_image_file_size">

			    <input id="share_image_url" type="hidden" name="share_image_url">
			    <input id="share_image_file_size" type="hidden" name="share_image_file_size">
			</form>

			<input id="originalImage" type="file" accept="image/*">
		</div>
		<div class="col-12" id="requestError"></div>
		<div class="col-12" id="requestSuccess" style="margin-top:20px;display:none;"></div>
		<div class="col-12" style="margin-top:20px;">
			<button class="btn btn-outline-danger" id="create-edit-channel">Create / Edit</button>
		</div>
	</div>

</div>
{{#contentFor "pageScripts"}}
	<script type="text/javascript">

	  $(document).ready(function() {





	    (function(window, $) {
          var Channel = function() {
            var oThis = this;

            oThis.config = {};

            oThis.apiUrl = $('meta[name="api-url"]').attr('content');

            oThis.createEditBtn = $('#create-edit-channel');
            oThis.imageUploadParams = {};
            oThis.imageNames = [];

            oThis.getPresignedPostUrl();

            oThis.bindEvents();
          };

          Channel.prototype = {
            bindEvents: function() {
              const oThis = this;

              // Generate report
              $(oThis.createEditBtn).click(function(event) {
                event.preventDefault();

                console.log('kya yeh kia....');

                $(oThis.createEditBtn).css('pointer-events', 'none');
                $(oThis.createEditBtn).html('Processing!...');
                $(oThis.createEditBtn).addClass('disabled');

                oThis.uploadImages();
              });
            },

            requestSuccessCallback: function() {
              const oThis = this;

              $(oThis.createEditBtn).css('pointer-events', 'auto');
              $(oThis.createEditBtn).html('Create / Edit');
              $(oThis.createEditBtn).removeClass('disabled');
            },

            requestFailureCallback: function() {
              const oThis = this;

              $(oThis.createEditBtn).css('pointer-events', 'auto');
              $(oThis.createEditBtn).html('Create / Edit');
              $(oThis.createEditBtn).removeClass('disabled');
            },

            getPresignedPostUrl: function() {
              var oThis = this;

              $.ajax({
                url: oThis.apiUrl + '/admin/channel/presigned-url',
                type: 'GET',
                contentType: 'application/json',
                success: function(response) {
                  if (response.data) {
                    console.log(response.data);

                    if (response.data.channel_upload_params && response.data.channel_upload_params.images) {
                      const imagesToUpload = response.data.channel_upload_params.images;

                      for (let imageName in imagesToUpload) {
                        oThis.imageNames.push(imageName);
                        oThis.imageUploadParams[imageName] = oThis.imageUploadParams[imageName] || {};
                        oThis.imageUploadParams[imageName]['post_url'] = imagesToUpload[imageName].post_url;
                        oThis.imageUploadParams[imageName]['s3_url'] = imagesToUpload[imageName].s3_url;
                        const post_fields = imagesToUpload[imageName].post_fields;

                        for (let imu = 0; imu < post_fields.length; imu++) {
                          oThis.imageUploadParams[imageName]['post_fields'] =
                            oThis.imageUploadParams[imageName]['post_fields'] || {};
                          oThis.imageUploadParams[imageName]['post_fields'][post_fields[imu].key] = post_fields[imu].value;
                        }
                      }
                    }
                  } else {
                    console.error('=======Unknown response====.serialize', response);
                  }
                },
                error: function(error) {
                  console.error('===error', error);
                }
              });
            },

            uploadImages: function() {
              const oThis = this;

              const originalFiles = document.getElementById('originalImage').files;

              if (originalFiles.length > 0) {
                const originalFile = originalFiles[0];
                const originalFileSize = originalFile.size;
                const uploadImageName = oThis.imageNames[0];
                originalFile.name = uploadImageName;

                $('#original_image_file_size').val(originalFileSize);
                $('#original_image_url').val(oThis.imageUploadParams[uploadImageName]['s3_url']);

                const imagePostUrl = oThis.imageUploadParams[uploadImageName]['post_url'];
                const imageUploadParams = oThis.imageUploadParams[uploadImageName]['post_fields'];

                imageUploadParams['file'] = originalFile;
                imageUploadParams['enctype'] = 'multipart/form-data';
                imageUploadParams['success_action_status'] = '200';
                imageUploadParams['success-action-status'] = '200';

                console.log('-----1-----------imageUploadParams-------------------------------');
                console.log(imageUploadParams);

                // send ajax to api to create edit channel.
                $.ajax({
                  url: imagePostUrl,
                  type: 'POST',
                  data: oThis.getFormData(imageUploadParams),
                  encType: 'multipart/form-data',
                  processData: false,
                  contentType: false,
                  cache: false,
                  success: function(response) {
                    console.log(response);
                    oThis.uploadShareImage();
                  },
                  error: function(error) {
                    console.error('===error', error);
                  }
                });
              }
            },

            uploadShareImage: function() {
              const oThis = this;

              const shareImageFiles = document.getElementById('originalImage').files;

              if (shareImageFiles.length > 0) {
                const shareImageFile = shareImageFiles[0];
                const uploadImageName = oThis.imageNames[1];
                shareImageFile.name = uploadImageName;

                $('#share_image_file_size').val(shareImageFile.size);
                $('#share_image_url').val(oThis.imageUploadParams[uploadImageName]['s3_url']);

                const imagePostUrl = oThis.imageUploadParams[uploadImageName]['post_url'];
                const imageUploadParams = oThis.imageUploadParams[uploadImageName]['post_fields'];

                imageUploadParams['file'] = shareImageFile;
                imageUploadParams['enctype'] = 'multipart/form-data';
                imageUploadParams['success_action_status'] = '200';
                imageUploadParams['success-action-status'] = '200';

                console.log('-----2-----------imageUploadParams-------------------------------');
                console.log(imageUploadParams);

                // send ajax to api to create edit channel.
                $.ajax({
                  url: imagePostUrl,
                  type: 'POST',
                  data: oThis.getFormData(imageUploadParams),
                  encType: 'multipart/form-data',
                  processData: false,
                  contentType: false,
                  cache: false,
                  success: function(response) {
                    console.log(response);
                    oThis.createEditChannel();
                  },
                  error: function(error) {
                    console.error('===error', error);
                  }
                });
              }
            },

            getFormData(paramsList) {
              let formData = new FormData();
              for (let key in paramsList) {
                formData.append(key, paramsList[key]);
              }
              return formData;
            },

            createEditChannel: function(successCallback, failureCallback) {
              var oThis = this;

              var data = $('#channel-form').serializeArray({});

              var postData = {};

              for (var i = 0; i < data.length; i++) {
                if (data[i].value) {
                  postData[data[i].name] = data[i].value;
                }
              }

              // send ajax to api to create edit channel.
              $.ajax({
                url: oThis.apiUrl + '/admin/channel/edit',
                type: 'POST',
                data: JSON.stringify(postData),
                contentType: 'application/json',
                success: function(response) {
                  if (response.data) {
                    $('#requestSuccess').html('Request Successful.');
                    $('#requestSuccess').show();
                    oThis.requestSuccessCallback();
                  } else {
                    $('#requestError').html(JSON.stringify(response.err));
                    $('#requestError').show();
                    oThis.requestFailureCallback();
                    console.error('=======Unknown response====', response);
                  }
                },
                error: function(error) {
                  console.error('===error', error);
                  $('#requestError').html('Request Failed.');
                  $('#requestError').show();

                  oThis.requestFailureCallback();
                  if (error.responseJSON.err.code == 'UNAUTHORIZED') {
                    window.location = '/admin/unauthorized';
                  }
                }
              });
            }
          };

          window.Channel = Channel;
        })(window, jQuery);






	    var Community = new window.Channel();
	  });
	</script>
{{/contentFor}}
